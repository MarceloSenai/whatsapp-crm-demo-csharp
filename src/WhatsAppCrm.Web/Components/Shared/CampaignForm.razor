@inject HttpClient Http
@inject NavigationManager Nav

<div class="max-w-2xl mx-auto">
    @* Steps indicator *@
    <div class="flex items-center justify-center gap-2 mb-8">
        @for (int i = 1; i <= 4; i++)
        {
            var step = i;
            <div class="flex items-center">
                <div class="@($"w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium {(currentStep >= step ? "bg-[#25d366] text-white" : "bg-gray-200 text-gray-500")}")">@step</div>
                @if (step < 4)
                {
                    <div class="@($"w-12 h-0.5 {(currentStep > step ? "bg-[#25d366]" : "bg-gray-200")}")"></div>
                }
            </div>
        }
    </div>

    @* Step 1: Name + Template *@
    @if (currentStep == 1)
    {
        <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
            <h3 class="font-semibold text-gray-900 mb-4">Detalhes da Campanha</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome da Campanha</label>
                    <input type="text" @bind="name" placeholder="Ex: Follow-up Leads Q1"
                           class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#25d366]" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mensagem do Template</label>
                    <textarea @bind="templateText" rows="4" maxlength="1000" placeholder="Olá {{nome}}, ..."
                              class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#25d366] resize-none"></textarea>
                    <div class="text-right text-[11px] text-gray-400">@(templateText.Length)/1000</div>
                </div>
            </div>
        </div>
    }

    @* Step 2: Audience Tags *@
    @if (currentStep == 2)
    {
        <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
            <h3 class="font-semibold text-gray-900 mb-4">Audiência</h3>
            <p class="text-sm text-gray-500 mb-4">Selecione as tags para filtrar os destinatários:</p>
            <div class="grid grid-cols-3 gap-2">
                @foreach (var tag in availableTags)
                {
                    var isSelected = selectedTags.Contains(tag);
                    <button @onclick="() => ToggleTag(tag)"
                            class="@($"px-3 py-2 text-sm rounded-lg border transition-colors {(isSelected ? "border-[#25d366] bg-green-50 text-green-700" : "border-gray-200 text-gray-600 hover:bg-gray-50")}")">
                        @if (isSelected) { <span class="mr-1">✓</span> }
                        @tag
                    </button>
                }
            </div>
        </div>
    }

    @* Step 3: Rate Limit *@
    @if (currentStep == 3)
    {
        <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
            <h3 class="font-semibold text-gray-900 mb-4">Cadência de Envio</h3>
            <div class="text-center mb-6">
                <span class="text-4xl font-bold text-[#25d366]">@rateLimit</span>
                <span class="text-gray-500 text-sm ml-1">msgs/min</span>
            </div>
            <input type="range" min="5" max="60" step="5" @bind="rateLimit"
                   class="w-full accent-[#25d366]" />
            <div class="flex justify-between text-xs text-gray-400 mt-1">
                <span>5</span><span>60</span>
            </div>
        </div>
    }

    @* Step 4: Review *@
    @if (currentStep == 4)
    {
        <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
            <h3 class="font-semibold text-gray-900 mb-4">Revisão</h3>
            <div class="space-y-3 text-sm">
                <div><span class="text-gray-500">Nome:</span> <span class="font-medium">@name</span></div>
                <div><span class="text-gray-500">Tags:</span> <span class="font-medium">@(selectedTags.Count > 0 ? string.Join(", ", selectedTags) : "Todos os contatos")</span></div>
                <div><span class="text-gray-500">Cadência:</span> <span class="font-medium">@rateLimit msgs/min</span></div>
                <div>
                    <span class="text-gray-500">Mensagem:</span>
                    <p class="mt-1 p-3 bg-gray-50 rounded-lg text-gray-700 text-sm">@templateText</p>
                </div>
            </div>
        </div>
    }

    @* Navigation *@
    <div class="flex justify-between mt-6">
        <button @onclick="PrevStep" disabled="@(currentStep == 1)"
                class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg transition-colors disabled:opacity-50">
            Voltar
        </button>
        @if (currentStep < 4)
        {
            <button @onclick="NextStep" disabled="@(!CanAdvance)"
                    class="px-4 py-2 text-sm bg-[#25d366] text-white rounded-lg hover:bg-[#128c7e] transition-colors disabled:opacity-50">
                Próximo
            </button>
        }
        else
        {
            <button @onclick="Submit" disabled="@submitting"
                    class="px-4 py-2 text-sm bg-[#25d366] text-white rounded-lg hover:bg-[#128c7e] transition-colors disabled:opacity-50">
                @(submitting ? "Criando..." : "Criar Campanha")
            </button>
        }
    </div>
</div>

@code {
    private int currentStep = 1;
    private string name = "";
    private string templateText = "";
    private int rateLimit = 30;
    private HashSet<string> selectedTags = new();
    private bool submitting;

    private string[] availableTags = ["lead", "cliente", "vip", "prospecto", "construtora", "locadora", "prestadora", "pme"];

    private bool CanAdvance => currentStep switch
    {
        1 => !string.IsNullOrWhiteSpace(name) && !string.IsNullOrWhiteSpace(templateText),
        _ => true
    };

    private void NextStep() { if (currentStep < 4 && CanAdvance) currentStep++; }
    private void PrevStep() { if (currentStep > 1) currentStep--; }

    private void ToggleTag(string tag)
    {
        if (!selectedTags.Remove(tag)) selectedTags.Add(tag);
    }

    private async Task Submit()
    {
        submitting = true;
        try
        {
            var payload = new
            {
                name,
                templateText,
                audienceFilter = selectedTags.Count > 0
                    ? JsonSerializer.Serialize(new { tags = selectedTags.ToArray() })
                    : null,
                rateLimit
            };
            await Http.PostAsJsonAsync("/api/campaigns", payload);
            Nav.NavigateTo("/campaigns");
        }
        finally
        {
            submitting = false;
        }
    }
}
