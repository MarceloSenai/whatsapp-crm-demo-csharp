@inject HttpClient Http

@if (contacts == null)
{
    <div class="flex items-center justify-center h-32">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-[#25d366]"></div>
    </div>
}
else
{
    @* Search + Stats *@
    <div class="mb-4 flex items-center gap-4">
        <div class="relative flex-1">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
            <input type="text" @bind="searchTerm" @bind:event="oninput" placeholder="Buscar por nome ou telefone..."
                   class="w-full pl-9 pr-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#25d366]" />
        </div>
        <div class="flex gap-4 text-sm text-gray-500">
            <span>Total: <strong class="text-gray-900">@contacts.Count</strong></span>
            <span>Ativos: <strong class="text-green-600">@contacts.Count(c => !c.OptedOut)</strong></span>
            <span>Opt-out: <strong class="text-red-600">@contacts.Count(c => c.OptedOut)</strong></span>
        </div>
    </div>

    @* Tabs *@
    <div class="flex gap-1 mb-4">
        @foreach (var tab in new[] { ("all", "Todos"), ("active", "Ativos"), ("optout", "Opt-out") })
        {
            <button @onclick="() => activeTab = tab.Item1"
                    class="@($"px-3 py-1.5 text-xs rounded-lg transition-colors {(activeTab == tab.Item1 ? "bg-[#25d366] text-white" : "text-gray-500 hover:bg-gray-100")}")">
                @tab.Item2
            </button>
        }
    </div>

    @* Table *@
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-gray-200 bg-gray-50">
                        <th class="text-left text-xs font-medium text-gray-500 px-4 py-3">Nome</th>
                        <th class="text-left text-xs font-medium text-gray-500 px-4 py-3">Telefone</th>
                        <th class="text-left text-xs font-medium text-gray-500 px-4 py-3">Tags</th>
                        <th class="text-center text-xs font-medium text-gray-500 px-4 py-3">Conversas</th>
                        <th class="text-center text-xs font-medium text-gray-500 px-4 py-3">Deals</th>
                        <th class="text-center text-xs font-medium text-gray-500 px-4 py-3">Status</th>
                        <th class="text-center text-xs font-medium text-gray-500 px-4 py-3">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var c in FilteredContacts)
                    {
                        <tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors">
                            <td class="px-4 py-3">
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-full bg-[#25d366] flex items-center justify-center flex-shrink-0">
                                        <span class="text-white text-xs font-semibold">@GetInitials(c.Name)</span>
                                    </div>
                                    <div>
                                        <div class="font-medium text-sm text-gray-900">@c.Name</div>
                                        <div class="text-[11px] text-gray-400">@c.Email</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-600">@Formatters.FormatPhone(c.Phone)</td>
                            <td class="px-4 py-3">
                                <div class="flex flex-wrap gap-1">
                                    @foreach (var tag in Formatters.ParseTags(c.Tags).Take(3))
                                    {
                                        <span class="@($"text-[10px] px-1.5 py-0.5 rounded-full {TagColor(tag)}")">@tag</span>
                                    }
                                </div>
                            </td>
                            <td class="px-4 py-3 text-center text-sm text-gray-600">@c.ConversationCount</td>
                            <td class="px-4 py-3 text-center text-sm text-gray-600">@c.DealCount</td>
                            <td class="px-4 py-3 text-center">
                                <span class="@($"text-[11px] px-2 py-0.5 rounded-full {(c.OptedOut ? "bg-red-100 text-red-700" : "bg-green-100 text-green-700")}")">
                                    @(c.OptedOut ? "Opt-out" : "Ativo")
                                </span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <button @onclick="() => ToggleOptOut(c)"
                                        class="@($"text-xs px-2 py-1 rounded transition-colors {(c.OptedOut ? "text-green-600 hover:bg-green-50" : "text-red-600 hover:bg-red-50")}")">
                                    @(c.OptedOut ? "Reativar" : "Opt-out")
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@code {
    private List<ContactDto>? contacts;
    private string searchTerm = "";
    private string activeTab = "all";

    private IEnumerable<ContactDto> FilteredContacts =>
        (contacts ?? [])
        .Where(c => activeTab == "all" || (activeTab == "active" && !c.OptedOut) || (activeTab == "optout" && c.OptedOut))
        .Where(c => string.IsNullOrEmpty(searchTerm)
            || c.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
            || c.Phone.Contains(searchTerm));

    protected override async Task OnInitializedAsync() => await LoadContacts();

    private async Task LoadContacts()
    {
        try { contacts = await Http.GetFromJsonAsync<List<ContactDto>>("/api/contacts"); }
        catch { }
    }

    private async Task ToggleOptOut(ContactDto c)
    {
        try
        {
            await Http.PatchAsJsonAsync("/api/contacts", new { id = c.Id, optedOut = !c.OptedOut });
            await LoadContacts();
        }
        catch { }
    }

    private string GetInitials(string name)
    {
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length >= 2 ? $"{parts[0][0]}{parts[^1][0]}" : $"{parts[0][0]}";
    }

    private string TagColor(string tag) => tag.ToLower() switch
    {
        "vip" => "bg-amber-100 text-amber-800",
        "lead" => "bg-blue-100 text-blue-800",
        "cliente" => "bg-green-100 text-green-800",
        "inativo" => "bg-gray-100 text-gray-800",
        "prospecto" => "bg-purple-100 text-purple-800",
        "construtora" => "bg-orange-100 text-orange-800",
        "locadora" => "bg-cyan-100 text-cyan-800",
        "prestadora" => "bg-pink-100 text-pink-800",
        "pme" => "bg-indigo-100 text-indigo-800",
        _ => "bg-gray-100 text-gray-700"
    };

    public class ContactDto
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string Phone { get; set; } = "";
        public string? Email { get; set; }
        public string Tags { get; set; } = "[]";
        public bool OptedOut { get; set; }
        public int ConversationCount { get; set; }
        public int DealCount { get; set; }
    }
}
